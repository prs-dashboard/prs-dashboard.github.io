<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsing parameters</title>
    <script defer>
        for (const [k, v] of new URL(document.location).searchParams) {
            console.log('search parameters:', k, v);
        }

        //https://github.com/auth0/docs/blob/master/articles/api-auth/tutorials/authorization-code-grant-pkce.md
        function sha256(buffer) {
            return crypto.createHash('sha256').update(buffer).digest();
        }

        function base64URLEncode(str) {
            return str.toString('base64')
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function getOAuthState() {
            let state = localStorage.getItem('oauth_state');
            if (!state) {
                const buffer = new ArrayBuffer(32);
                crypto.getRandomValues(new Int32Array(buffer));

                state = await crypto.subtle.digest('SHA-256', buffer);

                localStorage.setItem('oauth_state', state);
            }
            return state;
        }

        async function authorizeOnGithub() {
            const state = getOAuthState();

            const client_id = '41d953248c35fe869df5';
            const scope = 'user repo read:org';

            console.log('authorizeOnGithub', state);
            window.location = `https://github.com/login/oauth/authorize?client_id=${client_id}&redirect_uri=${encodeURI(window.location)}&response_type=code&scope=${encodeURI(scope)}&state=${state}`
        }

    </script>
</head>

<body>
    <a id="github-auth" href="#" onclick="authorizeOnGithub()">Authorize on github</a>
</body>

</html>
