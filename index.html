<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsing parameters</title>
    <script defer async>
        for (const [k, v] of new URL(document.location).searchParams) {
            console.log(k, v);
        }

        //https://github.com/auth0/docs/blob/master/articles/api-auth/tutorials/authorization-code-grant-pkce.md
        function sha256(buffer) {
            return crypto.createHash('sha256').update(buffer).digest();
        }

        function base64URLEncode(str) {
            return str.toString('base64')
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function getOAuthState() {
            localStorage.clear();
            let state = localStorage.getItem('oauth_state');
            if (!state) {
                const buffer = new ArrayBuffer(32);
                crypto.getRandomValues(new Int32Array(buffer));

                const digest = await crypto.subtle.digest('SHA-256', buffer);
                state = (new TextDecoder()).decode(digest);

                localStorage.setItem('oauth_state', state);
            }
            return state;
        }

        const oauth_client_id = '41d953248c35fe869df5';
        async function authorizeOnGithub() {
            const state = await getOAuthState();

            const scope = 'read:user repo read:org';

            console.log('authorizeOnGithub', state);
            window.location = `https://github.com/login/oauth/authorize?client_id=${oauth_client_id}&redirect_uri=${encodeURI(window.location)}&response_type=code&scope=${encodeURI(scope)}&state=${encodeURI(state)}`
        }

        async function checkOAuthState() {
            const params = new URL(document.location).searchParams;
            const code = params['code'];
            let state = params['state'];
            if (code === undefined || state === undefined) {
                console.log('Not a oauth flow');
                return;
            }

            try {
                state = decodeURI(state);
                if (state != await getOAuthState()) {
                    console.log('state mismatch, provided: ', state);
                    // to regenerate new state on next try
                    localStorage.removeItem('oauth_state');
                }
            } catch (e) {
                console.log(e);
            }

            const response = await fetch('https://github.com/login/oauth/access_token', {
                method: 'POST',
                body: JSON.stringify({
                    client_id: '41d953248c35fe869df5',
                    client_secret: 'c2db9b1b79560897293be6677d3e8bb4f1ecee43',
                    code: code,
                }),
                headers: {
                    Accept: 'application/json',
                    'Content-Type': 'application/json',
                },
            });
            if (response) {
                console.log(response);

                response = response.json();
                const oauth_access_token = response['access_token'];
                console.log(oauth_access_token);
                localStorage.saveItem('oauth_access_token', oauth_access_token);
            }
        }
        checkOAuthState();

    </script>
</head>

<body>
    <a id="github-auth" href="#" onclick="authorizeOnGithub()">Authorize on github</a>
</body>

</html>
